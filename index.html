<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.10.0/dist/css/uikit.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.10.0/dist/js/uikit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.10.0/dist/js/uikit-icons.min.js"></script>
    <script src="https://code.jquery.com/jquery-1.12.2.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <link rel="stylesheet" href="css/main.css">
    <title>Quiz</title>
</head>
<body id="body">




    <div class="uk-container">
        <div id="startQuizz">
            <h2>Allez vous êtes curieux pour le prix que ça côute  !! </h2>
            <button class='uk-button-primary uk-button-large'  onclick='displayQuizz()'>Cliquez ici</button>
        </div>

        <h3 id="estimation"></h3>
        <div class="uk-animation-toggle" tabindex="0">
            <div  id="quizz">
                <div class="uk-card contenuQuizz" id='affichage-question'></div>
                <div class="contenuQuizz uk-text-center" id='affichage-reponse'></div>
            </div>
        </div>

        <div id='affiche-bouton-retour'></div>
        <div id="recap"></div>
        <div id="boutonImprimer"></div>

    </div>

    







    <script>

    var totalValeur = 1000
    var lesIdsQuestions = []
    var ligneObjet = {}
    var recaps = []
    const quizz = document.querySelector("#quizz")

    // La fonction afficherLaQuestion prend en paramétre idQuestion
    function afficherLaQuestion (idQuestion, boutonRetourClique = false) {

        var urlCallQuestion = "https://api.airtable.com/v0/appDy1ud9kdkbSAOb/Questions/"+ idQuestion +"?api_key=keyxEX6nxNX72eMkB"
        $.ajax({
            url: urlCallQuestion,
            dataType: 'json',
   
            success: function(apiResponse) {

                //boutonRetourCliqué s'agit de boutonRetour pour chaque question par defaut il est à false
                if(boutonRetourClique == false){
                    lesIdsQuestions.push(idQuestion)
                }else{
                    lesIdsQuestions.pop(idQuestion)
                    recaps.pop()
                    boutonRetourClique = false
                }

                //$("#affiche-bouton-retour").html("")

                if(apiResponse.fields.isPremiere !== 1){
                    idQuestionPrecedente = lesIdsQuestions[lesIdsQuestions.length - 2]
                    if(typeof idQuestionPrecedente !== 'undefined'){
                    var boutonRetour = 
                        "<button class='uk-button-danger uk-button-small' id='bouton-retour'  onclick='afficherLaQuestion(idQuestionPrecedente, true)'>Retour</button>" 
                        $("#affiche-bouton-retour").html(boutonRetour)
                    }
   
                }
                //On affiche la question
                $(".contenuQuizz").hide()
                $("#affiche-bouton-retour").hide()
                if (typeof apiResponse.fields.txtQuestion !== 'undefined' && typeof apiResponse.fields.complement !== 'undefined') 
                {
                    
                    var questionTexte =
                        "<h2>" + apiResponse.fields.txtQuestion + "</h2>" +
                        "<h4>" + apiResponse.fields.complement + "</h4>"

                    $("#affichage-question").html(questionTexte)
                } else if (typeof apiResponse.fields.complement == 'undefined')
                {
                    questionTexte =
                        "<h2>" + apiResponse.fields.txtQuestion + "</h2>" 

                    $("#affichage-question").html(questionTexte)
                } 

                $.ajax({
                    url: 'https://api.airtable.com/v0/appDy1ud9kdkbSAOb/Reponses?filterByFormula=recordIdQuestionOrigine%20%3D%20%27'+ idQuestion +'%27&api_key=keyxEX6nxNX72eMkB',

                    dataType: 'json',
                    success: function(apiResponse) {
                        $("#affichage-reponse").html("")

                        //On crée les boutons oui ou non ou ... pour chaque réponse
                        //on injecte l'id de question suivante dans data-qst-suiv
                        //on injecte l'id de la réponse  dans data-qst-suiv
                        apiResponse.records.forEach(reponse => {

                            var reponseBouton = ""

                            var attributBoutonReponse = ""
                            //Si la question suivante et la réponse sont définis 
                            if (typeof reponse.fields.txtReponse !== 'undefined' && typeof reponse.fields.questionSuivante !== 'undefined') 
                            {
                                attributBoutonReponse =  "data-qst-suiv='" + reponse.fields.questionSuivante[0] + "'"

                            // si l'id question suivante n'est pas définie
                            }else if(typeof reponse.fields.questionSuivante == 'undefined'){

                            }
                            reponseBouton =
                                     "<button class='uk-button-primary uk-button-small  boutonReponse'  onclick='changeColor();' "+ attributBoutonReponse +"  data-id-reponse='" + reponse.id + "'>" + reponse.fields.txtReponse + "</button>" 
                                $("#affichage-reponse").append(reponseBouton)

                        })

                        $(".contenuQuizz").fadeIn(700)
                        $("#affiche-bouton-retour").fadeIn(700)

                        //On récupère les dataset de questionSuivante et dataset de l'id de réponse 
                        //on passe l'id de la réponse dans la requette pour récupérer les infos 
                        //correspandant à cett id
                        var lesBoutons = document.querySelectorAll(".boutonReponse")
                        lesBoutons.forEach( el => {
                            //quizz.classList.remove('fade-animation')
                            quizz.classList.remove('uk-animation-fade')
                            quizz.classList.remove('uk-animation-reverse')
                            el.addEventListener('click', (boutonClique) => {
                                
                                //quizz.classList.add('fade-animation')
                                quizz.classList.add('uk-animation-fade')
                                quizz.classList.add('uk-animation-reverse')
                                var questionSuivante = boutonClique.target.dataset.qstSuiv
                                var theReponseId = boutonClique.target.dataset.idReponse
                                
                                $.ajax({
                                    url: "https://api.airtable.com/v0/appDy1ud9kdkbSAOb/Reponses/"+ theReponseId +"?api_key=keyxEX6nxNX72eMkB",
                                    contentType : 'application/json',
                                    dataType : 'json',
                                    success: function(apiResponse) {
                                        //contient le prix donné à cette réponse
                                        var laValeurReponse = apiResponse.fields.valeur
                                        //contient la réponse en texte oui ou non
                                        var reponseDeChaque = apiResponse.fields.txtReponse
                                        //contient la description de la réponse
                                        var descriptionLigneDevis = apiResponse.fields.descriptionLigneDevis

                                        ligneObjet = {"prix": laValeurReponse, "description": descriptionLigneDevis}
                                        recaps.push(ligneObjet)

                                        $(".contenuQuizz").html("")
                                        $("#affiche-bouton-retour").html("")
                                        if(questionSuivante){
                                            afficherLaQuestion(questionSuivante, false)

                                        }else {
                                            afficherLeDevis()
                                            
                                        }
                                        
                                    }
                                })
                            })
                        })
                    }
                });
            }
        });
    }


    //fonction imprime imprime la page de récapitulatif
    function imprime(){
        window.print()
    }

    //cette fonction déclance l'affichage de quiz
    function displayQuizz(){
        let firstQuestion = "recHSWrcWfAccdXHK"
        const startQuizz = document.querySelector("#startQuizz")
        startQuizz.innerHTML = ""
        afficherLaQuestion(firstQuestion, false)
        changeColor()
    }

    
    //fonction pour afficher le devis
    function afficherLeDevis(){
        const recap = document.querySelector("#recap")
        const boutonRetour = document.querySelector("#affiche-bouton-retour")
        const boutonImprimer = document.querySelector("#boutonImprimer")

        recaps.forEach(record => {
            totalValeur += record.prix
            console.log(record)
        })
        quizz.innerHTML = "<h1>A bientôt</h1><h3>L'estimation de prix de votre site s'élève à "+ totalValeur +"€</h3>"
        boutonRetour.innerHTML = ""
        boutonImprimer.innerHTML = "<button type='submit' class='uk-button-primary uk-button-small' onclick='imprime()'>Imprimer</button>"
        recap.innerHTML = createTableRecapitulatif()
    }

    // on crée la table de récapitulatif
    function createTableRecapitulatif() {
        let tableString = "<table><thead><tr><th>Description</th><th>Prix</th></tr></thead><tbody>"
            recaps.forEach(recap => {
                if(typeof recap.description !== 'undefined' && typeof recap.prix !== 'undefined'){
                tableString += "<tr><td>"+ recap.description +"</td><td>"+ recap.prix +"</td></tr>"
                }else if(typeof recap.description == 'undefined'){
                    tableString += "<tr><td>Ii y a pas de description pour le moment</td><td>"+ recap.prix +"</td></tr>"
               }
            })
            
        tableString += "</tbody></table>"                  
        return tableString
    }



    var colors = ["#A3E4DB", "#F4EEA9", "#F5EEDC", "#FED2AA", "#E6E6E6", "#FFEDD3"];
    var colorIndex = 0;
    function changeColor() {

        let col = document.getElementById("body");
        if( colorIndex >= colors.length ) {
            colorIndex = 0;
        }
        col.style.backgroundColor = colors[colorIndex];
        colorIndex++;
    }


    </script>
</body>
</html>
